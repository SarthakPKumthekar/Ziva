#!/usr/bin/env groovy

pipeline {
    agent none
    options {
        skipDefaultCheckout true
        timestamps()
        timeout(time: 15, unit: 'MINUTES')
    }
    stages {
        stage('get sources') {
            agent { label 'git' && 'linux' }  // must checkout to a linux machine to avoid line ending issue
            steps {
                echo 'running checkout ziva-vfx-utils stage'

                dir('ziva-vfx-utils') {
                    checkout scm
                }
                stash(name: 'main', includes: 'ziva-vfx-utils/**')
            }
            post { cleanup { cleanWs() } }
        }
        stage('run tests for ziva-vfx-utils') {
            when {
                expression {
                    return !previousBuildSuccessful()
                }
            }

            failFast true
            parallel {
                stage('windows') {
                    options { timeout(time: 15, unit: 'MINUTES') }
                    agent { label 'windows && vfx && maya2019' }
                    environment {
                        mayaVersion = "2018" // variations: 2016, 2016.5, 2017, 2018, 2019
                    }
                    steps {
                        unstash 'main'
                        runWindowsTestStage()
                    }
                    post { cleanup { cleanWs() } }
                }

                stage('centos7') {
                    options { timeout(time: 15, unit: 'MINUTES') }
                    agent { label 'linux && centos7 && maya2019' }
                    environment {
                        mayaVersion = "2019"
                    }
                    steps {
                        unstash 'main'
                        runLinuxTestStage()
                    }
                    post { cleanup { cleanWs() } }
                }

                stage('centos6') {
                    options { timeout(time: 15, unit: 'MINUTES') }
                    agent { label 'centos6 && vfx' }
                    environment {
                        mayaVersion = "2016"
                    }
                    steps {
                        unstash 'main'
                        runLinuxTestStage()
                    }
                    post { cleanup { cleanWs() } }
                }
            }
        }
    }
}

// Return true iff the previous build has completed with a result indicating SUCCESS.
// NOTE: This mean that this function returns false when the previous build hasn't finished yet,
//       in addition to when it failed, or was aborted. If it hasn't finished yet, we can't know for
//       sure that it will succeed, so the safest thing to do is to assume the worst, and behave as
//       though it failed.
def previousBuildSuccessful() {
    def previousBuild = currentBuild.previousBuild
    if (previousBuild) {
        def success = previousBuild.result == "SUCCESS"
        if (!success) {
            echo "Previous build not successful."
        }
        return success
    }
    echo "No previous build found."
    return false
}

def runWindowsTestStage() {
    echo "running windows test stage"

    environment {
        zivadyn_LICENSE="${env.zivadyn_LICENSE};C:\\ziva"
    }

    dir('ziva-vfx-utils/test/CmtTests') {
        bat 'python run_zbuilder_test.py --maya ${mayaVersion}'
    }
}

def runLinuxTestStage() {
    echo "running linux test stage"

    dir('ziva-vfx-utils/test/CmtTests') {
        withEnv([
          "zivadyn_LICENSE=${env.zivadyn_LICENSE}:/var/ziva"
        ]) {
            sh 'python run_zbuilder_test.py --maya ${mayaVersion}'
        }
    }
}
